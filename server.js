const express = require('express')
const app = express()
const cors = require('cors')
const c2j = require('csvtojson')
const inventory = './ecomm-inventory.csv'
const sales = './ecomm-sales.csv'

// const request = (file) => {
//     c2j().fromFile(file)
//     .then((jsonObj)=>{
//         console.log(jsonObj)
//         res.send(jsonObj)
//     })
//     .catch((err) => {
//         console.log(err)
//         res.send('WE MESSED UP')
//     })
// }

const corsOptions = {
    origin: 'http://localhost:3000',
    optionsSuccessStatus: 200 // some legacy browsers (IE11, various SmartTVs) choke on 204
  }

app.use(cors(corsOptions))

app.get('/inventory', cors(corsOptions), async (req, res) => {
    c2j().fromFile(inventory)
    .then((jsonObj)=>{
        
        // console.log(jsonObj.slice(0, 20))
        // res.send(jsonObj.slice(0, 200))
        // [1,2,3,4,5]
        const transitioned = jsonObj.slice(0, 200).reduce((prev, cur) => {
            console.log('PREV', prev)
            console.log('CUR', cur)
            return { 
                ...prev, 
                // [cur.Country] just says set cur.Country as the key
                // (prev[cur.Country] || 0) means if the key already existed, else 0
                [cur.Country]: [ ...(prev[cur.Country] || []), cur.UnitPrice ]
            }
        }, {})
        console.log(transitioned)
        res.send(transitioned)
    })
    .catch((err) => {
        console.log(err)
        res.send('WE MESSED UP')
    })
})

app.get('/piechart', async (req, res) => {
    this.request(sale)
})




































































































































































































































































































































































































































































































































































































































































































































































































































































































































app.listen(
    process.env.PORT, 
    () => console.log(`Example app listening at http://localhost:${process.env.PORT}`)
)